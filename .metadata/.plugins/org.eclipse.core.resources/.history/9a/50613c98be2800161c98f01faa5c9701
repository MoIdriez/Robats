//============================================================================
// Name        : RobatsEngine.cpp
// Author      : Mohamed Idries
// Version     :
// Copyright   : Just use it for awesome stuff
// Description : Hello World in C++, Ansi-style
//============================================================================

#include <iostream>
// libcflie
#include "ControlEngine/GamePad.h"
#include "ControlEngine/AutoFlight.h"
#include "CrazyFlieEngine/CCrazyflie.h"
#include "CommunicationEngine/CrazyflieServer.h"

bool altHold = false; // just so that we set it once
bool gamepadEnabled = true;
bool autoflightEnabled = false;
struct gp_values gpv;
GamePad *gamepad = new GamePad();
AutoFlight *af = new AutoFlight();

void gamePadControl(CCrazyflie *cflieCopter, bool output = false, bool minimal = false) {
	gamepad->readValues(&gpv);
	cflieCopter->setThrust(gpv.thrust);
	cflieCopter->setRoll(gpv.roll);
	cflieCopter->setPitch(gpv.pitch);
	cflieCopter->setYaw(gpv.yaw);

	if (autoflightEnabled & gpv.althold) {
		if (!altHold) {
			af->setTargetAlt(cflieCopter->asl());
		}
		cflieCopter->setThrust(af->cycle(cflieCopter->asl(), cflieCopter->thrust()));
	} else {
		cflieCopter->setThrust(gpv.thrust);
	}

	if (output) {
		if (minimal) {
			cout << cflieCopter->thrust() << "," << cflieCopter->roll() << "," << cflieCopter->pitch() << "," << cflieCopter->yaw() << endl;
		} else {
			cout << "T: " << cflieCopter->thrust() << "\tR: " << cflieCopter->roll() << "\tP: " << cflieCopter->pitch() << "\tY: " << cflieCopter->yaw() << endl;
		}
	}
}

void logAcc(CCrazyflie *cflieCopter) { std::cout << cflieCopter->accX() << "," << cflieCopter->accY() << ","	 << cflieCopter->accZ() << std::endl; }

void cfCycle(CCrazyflie *cflieCopter) {
	if (gamepadEnabled) {
		gamePadControl(cflieCopter);
	}
}

int main(int argc, char **argv) {

	CCrazyRadio *crRadio = new CCrazyRadio("radio://0/10/250K");
//
	if (crRadio->startRadio()) {

//		int data[4];

//		struct gp_event gpe;

		CCrazyflie *cflieCopter = new CCrazyflie(crRadio);

//		af->hover(11.5);
		cflieCopter->setThrust(10001);
//
//		//CrazyflieServer *sockety = new CrazyflieServer(4444, data);
//		// Enable sending the setpoints. This can be used to temporarily
//		// stop updating the internal controller setpoints and instead
//		// sending dummy packets (to keep the connection alive).
		cflieCopter->setSendSetpoints(true);
//
		while (cflieCopter->cycle()) {
			//cflieCopter->setThrust(43001);
////			data[0] = cflieCopter->adc();
////			data[1] = cflieCopter->accX();
////			data[2] = cflieCopter->accY();
////			data[3] = cflieCopter->accZ();
////			cout << "Send Data: " << data[0] << "," << data[1] << "," << data[2]
////					<< "," << data[3] << endl;
			if (gamepad->readValues(&gpv)) {
////				cout<< "Data: " << cflieCopter->adc() << "\nGamepad: Thrust " << gpv.thrust << ", Roll " << gpv.roll << ", Pitch " << gpv.pitch << ", Yaw " << gpv.yaw << endl;
////				cflieCopter->setThrust(gpv.thrust);
////				cflieCopter->setRoll(gpv.roll);
////				cflieCopter->setPitch(gpv.pitch);
////				cflieCopter->setYaw(gpv.yaw);
			}
//			cout<< "Data: " << cflieCopter->adc() << endl;// << "\nGamepad: Thrust " << gpv.thrust << ", Roll " << gpv.roll << ", Pitch " << gpv.pitch << ", Yaw " << gpv.yaw << endl;
//			cout << "GyroX: " << cflieCopter->gyroX() << ", GyroY: " << cflieCopter->gyroY() << ", GyroZ: " << cflieCopter->gyroZ() << endl;
////			cout << "AccX: " << cflieCopter->accX() << ", AccY: " << cflieCopter->accY() << ", AccZ: " << cflieCopter->accZ() << endl;
//			cout<< "Asl: " <<cflieCopter->asl() << ", AslLong" << cflieCopter->aslLong() << ", Pressure" << cflieCopter->pressure() << ", Temperature" << cflieCopter->temperature() << endl;
			cflieCopter->setThrust(gpv.thrust);
//			cflieCopter->setRoll(0);
//			cflieCopter->setPitch(0);
//			cflieCopter->setYaw(0);
			cflieCopter->setRoll(gpv.roll);
			cflieCopter->setPitch(gpv.pitch);
			cflieCopter->setYaw(gpv.yaw);
			if (gpv.althold) {
				cout<< "Yep" <<endl;
				af->hover(cflieCopter->asl());
			} else {
				af->stop();
			}

//
//			if (gamepad->readEvent(&gpe)) {
//				printf("Event: time %8u, value %8hd, type: %3u, axis/button: %u\n", gpe.time, gpe.value, gpe.type, gpe.number);
//			}

	}
//
	delete cflieCopter;
	} else {
		std::cerr << "Could not connect to dongle. Did you plug it in?"
				<< std::endl;
	}

	delete crRadio;
	return 0;
}
